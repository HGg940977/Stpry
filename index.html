<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Neon Story Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-glow: rgba(0, 255, 255, 0.7);
            --secondary-glow: rgba(255, 0, 255, 0.7);
            --admin-reply-glow: rgba(255, 215, 0, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif; background-color: #0e0e0e; color: #f0f0f0;
            background-image: radial-gradient(circle at top left, rgba(159, 0, 255, 0.2), transparent 30%), radial-gradient(circle at bottom right, rgba(0, 255, 255, 0.2), transparent 30%);
            background-attachment: fixed; min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .glass-box {
            background: rgba(20, 20, 30, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem; margin-bottom: 2rem;
        }
        h1, h2 {
            font-weight: 700; margin-bottom: 1.5rem;
            background: linear-gradient(90deg, #ff00ff, #9f00ff, #00ffff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center;
        }
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-box { width: 100%; max-width: 400px; }
        .admin-dashboard { display: none; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .chapter-list { list-style: none; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .chapter-list::-webkit-scrollbar { width: 5px; }
        .chapter-list::-webkit-scrollbar-thumb { background: var(--primary-glow); border-radius: 10px; }
        .list-item {
            background: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem; margin-bottom: 1rem;
            border-left: 3px solid var(--primary-glow);
        }
        .list-item-header { display: flex; justify-content: space-between; align-items: center; }
        .list-item h4 { margin: 0; color: #fff; }
        .list-item .reactions-info { font-size: 0.8rem; color: #aaa; margin-top: 4px; }
        .list-item .actions { margin-top: 1rem; }
        .list-item .actions button { font-size: 0.8rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #ccc; }
        input, textarea {
            width: 100%; padding: 0.8rem 1rem; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px;
            color: #f0f0f0; font-family: 'Poppins', sans-serif; transition: all 0.3s ease;
        }
        textarea { min-height: 120px; resize: vertical; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary-glow); box-shadow: 0 0 15px var(--primary-glow); }
        button { cursor: pointer; border: none; padding: 0.8rem 1.5rem; font-family: 'Poppins', sans-serif; font-weight: 700; border-radius: 50px; transition: all 0.3s ease; }
        button:hover { transform: scale(1.05); }
        .btn-solid { background: linear-gradient(90deg, #9f00ff, #ff00ff); color: white; }
        .btn-solid:hover { box-shadow: 0 0 20px #ff00ff; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-glow); color: var(--primary-glow); }
        .btn-outline:hover { background: var(--primary-glow); color: #0e0e0e; }
        .btn-danger { background: transparent; border: 2px solid #ff4d4d; color: #ff4d4d; }
        .btn-danger:hover { background: #ff4d4d; color: white; }
        #auth-error { color: #ff4d4d; text-align: center; margin-top: 1rem; height: 1em; }
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; border-radius: 15px; background: linear-gradient(90deg, #9f00ff, #00ffff); color: white; box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4); transition: bottom 0.5s ease-in-out; z-index: 3000; }
        .toast.show { bottom: 30px; }
        #comments-modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: rgba(20, 20, 30, 0.9); border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 10vh auto; padding: 2rem; border-radius: 25px;
            width: 90%; max-width: 700px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--primary-glow); padding-bottom: 1rem; margin-bottom: 1rem; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: white; }
        #modal-comments-list { list-style: none; max-height: 40vh; overflow-y: auto; padding-right: 10px; }
        .modal-comment-item { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
        .modal-comment-item.is-reply { border-left: 2px solid var(--admin-reply-glow); }
        .modal-comment-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-comment-author { font-weight: bold; }
        .modal-comment-author.is-reply { color: var(--admin-reply-glow); }
        .modal-comment-date { font-size: 0.8rem; color: #999; }
        .modal-comment-text { margin: 0.5rem 0; }
        .modal-comment-actions button { font-size: 0.7rem; padding: 0.3rem 0.6rem; }
        #reply-form { margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 1.5rem; }
</style>
</head>
<body>

<div id="authContainer" class="auth-container">
    <div class="glass-box auth-box">
        <h1>Story CMS Login</h1>
        <form id="loginForm">
            <div class="form-group"><label for="email">Email</label><input type="email" id="email" required></div>
            <div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div>
            <button type="submit" class="btn-solid" style="width: 100%;">Login</button>
            <p id="auth-error"></p>
        </form>
    </div>
</div>

<div id="dashboardContainer" class="admin-dashboard container">
    <header>
        <h1>Story Management</h1>
        <button id="logoutBtn" class="btn-outline">Logout</button>
    </header>

    <div class="dashboard-grid">
        <div class="glass-box">
            <h2>Author & Story Details</h2>
            <form id="authorForm">
                <div class="form-group"><label for="author-name">Author Name</label><input type="text" id="author-name" required></div>
                <div class="form-group"><label for="author-bio">Author Bio</label><textarea id="author-bio" required></textarea></div>
                <div class="form-group"><label for="author-image-url">Author Picture URL</label><input type="url" id="author-image-url"></div>
                <button type="submit" class="btn-solid">Save Author Info</button>
            </form>
            <hr style="border-color: rgba(255,255,255,0.2); margin: 2rem 0;">
            <form id="storyForm">
                <div class="form-group"><label for="story-title">Story Title</label><input type="text" id="story-title" required></div>
                <div class="form-group"><label for="story-intro">Story Introduction</label><textarea id="story-intro" required></textarea></div>
                <div class="form-group"><label for="story-image-url">Story Banner URL</label><input type="url" id="story-image-url" required></div>
                <button type="submit" class="btn-solid">Save Story Info</button>
            </form>
        </div>
        <div class="glass-box">
            <h2>Manage Chapters</h2>
            <ul id="chapterList" class="chapter-list"></ul>
        </div>
    </div>
    <div class="glass-box">
        <h2>Add / Edit Chapter</h2>
        <form id="chapterForm">
            <div class="form-group"><label for="chapter-number">Chapter Number (e.g., 1, 2, 3)</label><input type="number" id="chapter-number" min="1" required></div>
            <div class="form-group"><label for="chapter-title">Chapter Title</label><input type="text" id="chapter-title" required></div>
            <div class="form-group"><label for="chapter-summary">Chapter Summary</label><textarea id="chapter-summary" rows="3"></textarea></div>
            <div class="form-group"><label for="chapter-content">Full Chapter Text</label><textarea id="chapter-content" required></textarea></div>
            <div class="form-group"><label for="chapter-image-url">Chapter Image URL (Optional)</label><input type="url" id="chapter-image-url"></div>
            
            <!-- NEW: Audio and Video Link Fields -->
            <div class="form-group"><label for="chapter-audio-link">Audio Link (Optional)</label><input type="url" id="chapter-audio-link"></div>
            <div class="form-group"><label for="chapter-video-link">Video Link (Optional, use YouTube link)</label><input type="url" id="chapter-video-link"></div>
            
            <button type="submit" class="btn-solid">Save Chapter</button>
            <button type="button" id="clearChapterFormBtn" class="btn-outline" style="margin-left: 1rem;">Clear Form</button>
        </form>
    </div>
</div>

<div id="comments-modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-chapter-title">Comments</h2><span class="close-modal">×</span></div>
        <ul id="modal-comments-list"></ul>
        <form id="reply-form">
            <h3>Post a Reply (as Admin)</h3>
            <div class="form-group"><textarea id="reply-text" rows="3" required placeholder="Write your reply..."></textarea></div>
            <button type="submit" class="btn-solid">Post Reply</button>
        </form>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCWMozjfmSn05uvl24J9adWcukPAH4yOnQ",
        authDomain: "app-store-9614f.firebaseapp.com",
        databaseURL: "https://app-store-9614f-default-rtdb.firebaseio.com",
        projectId: "app-store-9614f",
        storageBucket: "app-store-9614f.firebasestorage.app",
        messagingSenderId: "295035335263",
        appId: "1:295035335263:web:aa2d53f9a5d7fdf6bfe1ea",
    };

    const adminApp = firebase.initializeApp(firebaseConfig, 'adminApp');
    const adminAuth = adminApp.auth();
    const db = adminApp.database();
    let storyId = null;

    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const loginForm = document.getElementById('loginForm');
    const authError = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logoutBtn');
    const chapterList = document.getElementById('chapterList');
    const commentsModal = document.getElementById('comments-modal');
    const modalCommentsList = document.getElementById('modal-comments-list');
    const replyForm = document.getElementById('reply-form');
    let currentModalChapterId = null; 

    const showToast = (message) => {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    };
    const clearChapterForm = () => {
        document.getElementById('chapterForm').reset();
        document.getElementById('chapter-number').removeAttribute('readonly');
    };

    adminAuth.onAuthStateChanged(user => {
        if (user) {
            authContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
            loadAdminData();
        } else {
            authContainer.style.display = 'flex';
            dashboardContainer.style.display = 'none';
        }
    });

    loginForm.addEventListener('submit', e => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        authError.textContent = '';
        adminAuth.signInWithEmailAndPassword(email, password)
            .catch(error => authError.textContent = error.message);
    });
    
    logoutBtn.addEventListener('click', () => adminAuth.signOut());
    
    document.getElementById('authorForm').addEventListener('submit', e => {
        e.preventDefault();
        const authorData = {
            name: document.getElementById('author-name').value,
            bio: document.getElementById('author-bio').value,
            imageUrl: document.getElementById('author-image-url').value,
        };
        db.ref('author').set(authorData)
          .then(() => showToast('Author info saved!'))
          .catch(err => alert(err.message));
    });
    
    document.getElementById('storyForm').addEventListener('submit', e => {
        e.preventDefault();
        const storyData = {
            title: document.getElementById('story-title').value,
            intro: document.getElementById('story-intro').value,
            imageUrl: document.getElementById('story-image-url').value,
        };
        const ref = storyId ? db.ref(`stories/${storyId}`) : db.ref('stories').push();
        ref.update(storyData)
          .then(() => showToast('Story info saved!'))
          .catch(err => alert(err.message));
    });

    // --- UPDATED: chapterForm Submit Event Listener ---
    document.getElementById('chapterForm').addEventListener('submit', e => {
        e.preventDefault();
        if (!storyId) {
            alert('Please save the main story info before adding chapters.');
            return;
        }
        const chapterNum = document.getElementById('chapter-number').value;
        const chapterData = {
            title: document.getElementById('chapter-title').value,
            summary: document.getElementById('chapter-summary').value,
            content: document.getElementById('chapter-content').value,
            imageUrl: document.getElementById('chapter-image-url').value || null,
            // NEW: Saving audio and video links
            audioLink: document.getElementById('chapter-audio-link').value.trim() || null,
            videoLink: document.getElementById('chapter-video-link').value.trim() || null,
        };
        
        db.ref(`stories/${storyId}/chapters/${chapterNum}`).update(chapterData)
          .then(() => {
            showToast(`Chapter ${chapterNum} saved successfully!`);
            clearChapterForm();
          })
          .catch(err => alert(err.message));
    });

    document.getElementById('clearChapterFormBtn').addEventListener('click', clearChapterForm);

    function loadAdminData() {
        db.ref('author').on('value', snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById('author-name').value = data.name || '';
                document.getElementById('author-bio').value = data.bio || '';
                document.getElementById('author-image-url').value = data.imageUrl || '';
            }
        });

        db.ref('stories').limitToFirst(1).on('value', snapshot => {
            chapterList.innerHTML = '';
            if (snapshot.exists()) {
                storyId = Object.keys(snapshot.val())[0];
                const data = snapshot.val()[storyId];

                document.getElementById('story-title').value = data.title || '';
                document.getElementById('story-intro').value = data.intro || '';
                document.getElementById('story-image-url').value = data.imageUrl || '';

                if (data.chapters) {
                    renderChapterList(data.chapters);
                } else {
                     chapterList.innerHTML = '<li><p>No chapters yet. Add one below.</p></li>';
                }
            } else {
                chapterList.innerHTML = '<li><p>No story found. Fill out "Story Info" and save to begin.</p></li>';
            }
        });
    }
    
    function renderChapterList(chapters) {
        chapterList.innerHTML = '';
        Object.entries(chapters).sort((a,b) => parseInt(a[0]) - parseInt(b[0])).forEach(([id, data]) => {
            const likes = data.likes || 0;
            const dislikes = data.dislikes || 0;
            const commentCount = data.comments ? Object.keys(data.comments).length : 0;

            const listItem = document.createElement('li');
            listItem.className = 'list-item';
            listItem.innerHTML = `
                <div class="list-item-header">
                    <div>
                        <h4>Chapter ${id}: ${data.title}</h4>
                        <div class="reactions-info">👍 ${likes}  👎 ${dislikes}  💬 ${commentCount}</div>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn-outline btn-edit" data-id="${id}">Edit</button>
                    <button class="btn-danger btn-delete" data-id="${id}">Delete</button>
                    <button class="btn-outline btn-view-comments" data-id="${id}">View Comments</button>
                </div>
            `;
            chapterList.appendChild(listItem);
        });
    }

    // --- UPDATED: Edit Button Click Handler ---
    chapterList.addEventListener('click', e => {
        const target = e.target;
        const chapId = target.getAttribute('data-id');
        if (!chapId) return;

        if (target.classList.contains('btn-delete')) {
            if (confirm(`Are you sure you want to delete Chapter ${chapId}? This cannot be undone.`)) {
                db.ref(`stories/${storyId}/chapters/${chapId}`).remove()
                  .then(() => showToast(`Chapter ${chapId} deleted.`))
                  .catch(err => alert(err.message));
            }
        } else if (target.classList.contains('btn-edit')) {
            db.ref(`stories/${storyId}/chapters/${chapId}`).once('value', snapshot => {
                const data = snapshot.val();
                document.getElementById('chapter-number').value = chapId;
                document.getElementById('chapter-number').setAttribute('readonly', true);
                document.getElementById('chapter-title').value = data.title;
                document.getElementById('chapter-summary').value = data.summary;
                document.getElementById('chapter-content').value = data.content;
                document.getElementById('chapter-image-url').value = data.imageUrl || '';
                // NEW: Populating audio and video fields on edit
                document.getElementById('chapter-audio-link').value = data.audioLink || '';
                document.getElementById('chapter-video-link').value = data.videoLink || '';
                showToast(`Editing Chapter ${chapId}. Scroll down to the form.`);
                document.getElementById('chapterForm').scrollIntoView({ behavior: 'smooth' });
            });
        } else if (target.classList.contains('btn-view-comments')) {
            openCommentsModal(chapId);
        }
    });

    function openCommentsModal(chapterId) {
        currentModalChapterId = chapterId;
        document.getElementById('modal-chapter-title').textContent = `Comments for Chapter ${chapterId}`;
        const commentsRef = db.ref(`stories/${storyId}/chapters/${chapterId}/comments`).orderByChild('timestamp');
        
        commentsRef.on('value', snapshot => {
            modalCommentsList.innerHTML = '';
            if (!snapshot.exists()) {
                modalCommentsList.innerHTML = '<li>No comments on this chapter yet.</li>';
                return;
            }
            snapshot.forEach(child => {
                const commentId = child.key;
                const comment = child.val();
                const date = new Date(comment.timestamp).toLocaleString();
                const li = document.createElement('li');
                li.className = `modal-comment-item ${comment.isReply ? 'is-reply' : ''}`;
                li.innerHTML = `
                    <div class="modal-comment-header">
                        <div>
                            <strong class="modal-comment-author ${comment.isReply ? 'is-reply' : ''}">${comment.name}</strong>
                            <div class="modal-comment-date">${date}</div>
                        </div>
                        <div class="modal-comment-actions">
                            <button class="btn-danger btn-delete-comment" data-comment-id="${commentId}">Delete</button>
                        </div>
                    </div>
                    <p class="modal-comment-text">${comment.text.replace(/</g, "&lt;")}</p>
                `;
                modalCommentsList.prepend(li);
            });
        });
        commentsModal.style.display = 'block';
    }

    document.querySelector('.close-modal').addEventListener('click', () => {
        if (currentModalChapterId) {
            db.ref(`stories/${storyId}/chapters/${currentModalChapterId}/comments`).off();
        }
        commentsModal.style.display = 'none';
        currentModalChapterId = null;
    });

    modalCommentsList.addEventListener('click', e => {
        if (e.target.classList.contains('btn-delete-comment')) {
            const commentId = e.target.dataset.commentId;
            if (confirm('Are you sure you want to delete this comment?')) {
                db.ref(`stories/${storyId}/chapters/${currentModalChapterId}/comments/${commentId}`).remove()
                    .then(() => showToast('Comment deleted.'))
                    .catch(err => alert(err.message));
            }
        }
    });

    replyForm.addEventListener('submit', e => {
        e.preventDefault();
        const replyText = document.getElementById('reply-text').value;
        if (!replyText.trim()) return;
        
        const replyData = {
            name: 'Admin',
            text: replyText,
            isReply: true,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref(`stories/${storyId}/chapters/${currentModalChapterId}/comments`).push(replyData)
            .then(() => {
                showToast('Reply posted successfully!');
                document.getElementById('reply-text').value = '';
            })
            .catch(err => alert(err.message));
    });
</script>
</body>
</html>
